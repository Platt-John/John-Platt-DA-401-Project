---
title: "Logistic Regression and RCS Analysis Part 3"
author: "John Platt"
date: "2025-10-29"
output: html_document
---

## Introduction

Ensuring assumptions are met beforehand and validating model fit, we conduct survey-weighted logistic regression stratified by the IRDSTNRV12 variable to examine the association between marijuana use and suicidal ideation. An unadjusted model without confounders will be conducted first, and subsequently, a fully adjusted model will be done.

## Logistic Regression Preparation

First, we get our dataset ready and check assumptions (don't need to check for multicollinearity or non-linearity now) before performing logistic regression.

```{r load in cleaned data and code binary outcome (suicidal ideation) as numerical}
#File -> New Project -> Set existing GitHub Repository as working directory with data2 as a subfolder outside the repository and the NSDUH_2023.Rdata file in the subfolder
#Load in the data
load("C:/Users/John Platt/OneDrive/data2/NSDUH_2021_2023.Rdata")
#Required packages:
#dplyr
library(dplyr) #data wrangling and manipulation
#Select a subset of the 2021-2023 NSDUH data that has the 27 necessary columns
data<-data %>% select(ANALWT2_C3,YEAR,VESTR_C,VEREP,IRSEX,CATAGE,NEWRACE2,EDUHIGHCAT,IRWRKSTAT18,IRHHSIZ2,IRPRVHLT,INCOME,IRALCFY,IRMJFY,IRCOCFY,IRCIGFM,IRNICVAP30N,IRHALLUCYFQ,IRALCBNG30D,SUTINPPY,IRDSTNRV12,IRDSTEFF12,IRIMPCONCN,IRSUICTHNK,IRAMDEYR,MHTINPPY,AMISUD5ANYO)
#Decoding of IRSEX column
data$IRSEX<-factor(data$IRSEX, 
                    levels=c(1,2),labels=c('Male',"Female"))
#Decoding of EDUHIGHCAT column
data$EDUHIGHCAT<-factor(data$EDUHIGHCAT, 
                    levels=c(1,2,3,4,5),
                    labels=c("Less high school","High school grad","Some coll/Assoc Dg","College graduate","12 to 17 year olds"))
#Decoding of IRPRVHLT column
data$IRPRVHLT<-factor(data$IRPRVHLT, 
                    levels=c(1,2),
                    labels=c("Yes","No"))
#Decoding of IRHHSIZ2 column
data$IRHHSIZ2<-factor(data$IRHHSIZ2, 
                    levels=c(1,2,3,4,5,6),
                    labels=c("One person in household","Two people in household","Three people in household","Four people in household","Five people in household","6 or more people in household"))
#Decoding of INCOME column
data$INCOME<-factor(data$INCOME,
                    levels=c(1,2,3,4),
                    labels=c("Less than $20,000","$20,000-$49,999","$50,000-$74,999","$75,000 or More"))
#Decoding of SUTINPPY column
data$SUTINPPY<-factor(data$SUTINPPY, 
                    levels=c(0,1),
                    labels=c("No","Yes"))
#Decoding of IRDSTNRV12 column
data$IRDSTNRV12<-factor(data$IRDSTNRV12, 
                    levels=c(1,2,3,4,5),
                    labels=c("All of the time","Most of the time","Some of the time","A little of the time","None of the time"))
#Decoding of IRDSTEFF12 column
data$IRDSTEFF12<-factor(data$IRDSTEFF12,
                        levels=c(1,2,3,4,5),
                        labels=c("All of the time","Most of the time","Some of the time","A little of the time","None of the time"))
#Decoding of IRIMPCONCN column
data$IRIMPCONCN<-factor(data$IRIMPCONCN,
                        levels=c(1,2,3,4),
                        labels=c("No difficulty","Mild difficultly","Moderate difficulty","Severe difficulty"))
#Decoding of IRSUICTHNK column
data$IRSUICTHNK<-factor(data$IRSUICTHNK,
                        levels=c(0,1),
                        labels=c("No","Yes"))
#Decoding of IRAMDEYR column
data$IRAMDEYR<-factor(data$IRAMDEYR,
                        levels=c(0,1),
                        labels=c("No","Yes"))
#Decoding of MHTINPPY column
data$MHTINPPY<-factor(data$MHTINPPY,
                        levels=c(0,1),
                        labels=c("No","Yes"))
#Decoding of AMISUD5ANYO column
#Note: missing values will be filtered out when examine the population subset: young adults
data$AMISUD5ANYO<-factor(data$AMISUD5ANYO,
                        levels=c(1,2,3,4),
                        labels=c("SUD only, no AMI","AMI only, no SUD","SUD and AMI","Neither SUD or AMI"))
#Replace missing values with 0 for substance use variables
zero_codes <- list(
  IRALCFY      = c(991, 993),
  IRCIGFM      = c(91, 93),
  IRMJFY       = c(991, 993),
  IRCOCFY      = c(991, 993),
  IRHALLUCYFQ  = c(991, 993),
  IRNICVAP30N  = c(91, 93),  # 91/93 here mean no use as well
  IRALCBNG30D  = c(91, 93)
)

for (v in names(zero_codes)) {
  data[[v]][data[[v]] %in% zero_codes[[v]]] <- 0
}
# Replace -9 (missing) with NA for these three variables only
vars_with_neg9 <- c("IRNICVAP30N", "SUTINPPY", "MHTINPPY")

for (v in vars_with_neg9) {
  if (v %in% names(data)) {
    data[[v]][data[[v]] == -9] <- NA
  }}
#Code suicidal ideation variable as numeric
data$IRSUICTHNK <- ifelse(data$IRSUICTHNK == "Yes", 1, ifelse(data$IRSUICTHNK == "No", 0, NA))
#Check data type of dataframe columns
str(data)
```

```{r dummy variables and illicit substance use conversion}
#Required packages:
#fastDummies
library(fastDummies) #Dummy variable creation
#Convert nominal variables into dummy variables and drop reference dummy to avoid "dummy variable trap"
data <- dummy_cols(data, select_columns = c("NEWRACE2","IRWRKSTAT18"), remove_first_dummy = TRUE, remove_selected_columns = TRUE)
head(data)
#Convert illicit substance use variables into categories 
data$IRMJFY2 <- cut(data$IRMJFY, breaks = 4, #number of categories 
                    labels = c("0-90", "90-180", "180-270", "270-360"), include.lowest = TRUE) 
data$IRCOCFY2 <- cut(data$IRCOCFY, breaks = 4, # number of categories 
                     labels = c("0-90", "90-180", "180-270", "270-360"), include.lowest = TRUE) 
data$IRHALLUCYFQ2 <- cut(data$IRHALLUCYFQ, breaks = 4, # number of categories 
                         labels = c("0-90", "90-180", "180-270", "270-360"), include.lowest = TRUE)
str(data)
```

```{r specify survey design and check sample size as well as strata and PSUs 1}
#Install survey package
library(survey) #Library for survey design
options(survey.lonely.psu = "adjust")  #common & documented choice to adjust variance if there are single psus within stratum
#Specify survey design
des <- svydesign(
  id      = ~VEREP, #PSU/cluster id
  strata  = ~VESTR_C, #variance strata
  weights = ~ANALWT2_C3, #analysis weight
  data    = data, #2021-2023 NSDUH dataframe
  nest = TRUE
)
#Check strata, PSUs, and effective sample size for each subgroup (subgroup 1)
young_adults1 <- subset(des, CATAGE == 2 & (IRDSTNRV12=="All of the time" | IRDSTNRV12=="Most of the time"))
#Number of unique strata and PSUs in the subpopulation
length(unique(young_adults1$variables$VESTR_C))
length(unique(young_adults1$variables$VEREP))
#Compute effective sample size
w <- weights(young_adults1)
ess <- (sum(w)^2) / sum(w^2)
print(ess)
#Subgroup2
young_adults2 <- subset(des, CATAGE == 2 & (IRDSTNRV12=="Some of the time" | IRDSTNRV12=="A little of the time" | IRDSTNRV12=="None of the time"))
#Number of unique strata and PSUs in the subpopulation
length(unique(young_adults2$variables$VESTR_C))
length(unique(young_adults2$variables$VEREP))
#Compute effective sample size
w <- weights(young_adults2)
ess <- (sum(w)^2) / sum(w^2)
print(ess)
```

# Logistic Regression 1
We do our adjusted and unadjusted logistic regression models for subgroup 1.

```{r unadjusted pseudo maximum likelihood logistic regression}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRMJFY2, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRSEX}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRSEX, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 2}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for EDUHIGHCAT}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ EDUHIGHCAT, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 3}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRPRVHLT}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRPRVHLT, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 4}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRHHSIZ2}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRHHSIZ2, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 5}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for INCOME}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ INCOME, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 6}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression FOR IRALCFY}
#Fit unadjusted logistic regression model between alcohol use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRALCFY, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 7}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRCIGFM}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRCIGFM, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 8}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRNICVAP30N}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRNICVAP30N, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 9}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRALCBNG30D}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRALCBNG30D, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 10}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for SUTINPPY}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ SUTINPPY, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 11}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for difficulty concentrating}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRIMPCONCN, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 13}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for NEWRACE2}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ NEWRACE2_2 + NEWRACE2_3 + NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 14}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRWRKSTAT18}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4, design = young_adults1, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 15}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r adjusted pseudo maximum likelihood logistic regression}
#Fit the adjusted PML logistic regression (quasibinomial for robust SEs)
fit <- svyglm(
  IRSUICTHNK ~ IRMJFY2 + IRSEX + EDUHIGHCAT + IRPRVHLT + IRHHSIZ2 + IRNICVAP30N + SUTINPPY + IRCIGFM + IRIMPCONCN +  IRALCFY + IRALCBNG30D +
               NEWRACE2_2 + NEWRACE2_3 + NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7 +
               IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4,
  design = young_adults1,
  family = quasibinomial()
)
#Coefficients → ORs with 95% CIs
co <- coef(fit)
vc <- vcov(fit)
se <- sqrt(diag(vc))
z  <- qnorm(0.975)
#Create dataframe with coefficients
est <- data.frame(
  term = names(co),
  beta = co,
  se   = se,
  OR   = exp(co),
  LCL  = exp(co - z*se),
  UCL  = exp(co + z*se),
  p    = 2*pnorm(-abs(co/se))
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

Now we add interactions into our adjusted logistic regression model (one at a time). Since we have less than 30 variables in our model including one main predictor, we will go ahead and test every possible interaction one at a time.

```{r PML adjusted logistic regression with interactions}
#Fit the adjusted PML logistic regression (quasibinomial for robust SEs) with interactions
fit_int <- svyglm(
 IRSUICTHNK ~ IRSEX + EDUHIGHCAT + IRPRVHLT + IRHHSIZ2  + IRALCFY + IRALCBNG30D + IRNICVAP30N + SUTINPPY + IRCIGFM + 
                NEWRACE2_2 + IRMJFY2 * NEWRACE2_3 + IRMJFY2 * NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7 + 
               IRIMPCONCN + IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4,
  design = young_adults1,
  family = quasibinomial()
)
#Coefficients → ORs with 95% CIs
co <- coef(fit_int)
vc <- vcov(fit_int)
se <- sqrt(diag(vc))
z  <- qnorm(0.975)
#Build dataframe with coefficients
est <- data.frame(
  term = names(co),
  beta = co,
  se   = se,
  OR   = exp(co),
  LCL  = exp(co - z*se),
  UCL  = exp(co + z*se),
  p    = 2*pnorm(-abs(co/se))
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
#Do design-adjusted wald test for interaction (p-value <.05 means the relationship between cannabis use and suicidal ideation significantly differs by the interaction term and coefficient for the interaction term is not equal to 0)
#regTermTest(fit_int, ~ NEWRACE2_4:IRMJFY2)
```

```{r plot residuals vs fitted values for adjusted PML model}
res_dev <- residuals(fit_int, type = "deviance")
plot(fitted(fit_int), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```



# Logistic Regression 2
We do our adjusted and unadjusted logistic regression models for subgroup 2.

```{r unadjusted pseudo maximum likelihood logistic regression}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRMJFY2, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRSEX}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRSEX, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 2}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for EDUHIGHCAT}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ EDUHIGHCAT, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 3}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRPRVHLT}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRPRVHLT, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 4}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRHHSIZ2}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRHHSIZ2, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 5}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for INCOME}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ INCOME, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 6}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression FOR IRALCFY}
#Fit unadjusted logistic regression model between alcohol use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRALCFY, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 7}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRCIGFM}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRCIGFM, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 8}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRNICVAP30N}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRNICVAP30N, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 9}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRALCBNG30D}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRALCBNG30D, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 10}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for SUTINPPY}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ SUTINPPY, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 11}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for difficulty concentrating}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRIMPCONCN, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 13}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for NEWRACE2}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ NEWRACE2_2 + NEWRACE2_3 + NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 14}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r unadjusted pseudo maximum likelihood logistic regression for IRWRKSTAT18}
#Fit unadjusted logistic regression model between marijuana use and suicidal ideation
fit <- svyglm(IRSUICTHNK ~ IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4, design = young_adults2, family = quasibinomial())
#Coefficients → ORs with 95% CIs
co <- coef(fit) #Beta coefficients
vc <- vcov(fit) #Variance-covariance matrix
se <- sqrt(diag(vc)) #Standard error
z  <- qnorm(0.975) #Z-score for 95% confidence interval
#Create dataframe with estimates
est <- data.frame(
  term = names(co), #Model variables
  beta = co, #Beta coefficient
  se   = se, #Standard eror
  OR   = exp(co), #Odds ratio
  LCL  = exp(co - z*se), #Odds ratio lower confidence level
  UCL  = exp(co + z*se), #Odds ratio upper confidence level
  p    = 2*pnorm(-abs(co/se)) #P-value for odds ratio
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

```{r plot residuals vs fitted values for unadjusted PML model 15}
res_dev <- residuals(fit, type = "deviance")
plot(fitted(fit), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```

```{r adjusted pseudo maximum likelihood logistic regression}
#Fit the adjusted PML logistic regression (quasibinomial for robust SEs)
fit <- svyglm(
  IRSUICTHNK ~ IRMJFY2 + IRSEX + EDUHIGHCAT + IRPRVHLT + IRHHSIZ2 + IRNICVAP30N + SUTINPPY + IRCIGFM + IRIMPCONCN +  IRALCFY + IRALCBNG30D +
               NEWRACE2_2 + NEWRACE2_3 + NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7 +
               IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4,
  design = young_adults2,
  family = quasibinomial()
)
#Coefficients → ORs with 95% CIs
co <- coef(fit)
vc <- vcov(fit)
se <- sqrt(diag(vc))
z  <- qnorm(0.975)
#Create dataframe with coefficients
est <- data.frame(
  term = names(co),
  beta = co,
  se   = se,
  OR   = exp(co),
  LCL  = exp(co - z*se),
  UCL  = exp(co + z*se),
  p    = 2*pnorm(-abs(co/se))
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
```

Now we add interactions into our adjusted logistic regression model (one at a time). Since we have less than 30 variables in our model including one main predictor, we will go ahead and test every possible interaction one at a time.

```{r PML adjusted logistic regression with interactions}
#Fit the adjusted PML logistic regression (quasibinomial for robust SEs) with interactions
fit_int <- svyglm(
 IRSUICTHNK ~ IRSEX + EDUHIGHCAT + IRPRVHLT + IRHHSIZ2  + IRALCFY + IRALCBNG30D + IRNICVAP30N + SUTINPPY + IRCIGFM + 
                NEWRACE2_2 + IRMJFY2 * NEWRACE2_3 + IRMJFY2 * NEWRACE2_4 + NEWRACE2_5 + NEWRACE2_6 + NEWRACE2_7 + 
               IRIMPCONCN + IRWRKSTAT18_2 + IRWRKSTAT18_3 + IRWRKSTAT18_4,
  design = young_adults2,
  family = quasibinomial()
)
#Coefficients → ORs with 95% CIs
co <- coef(fit_int)
vc <- vcov(fit_int)
se <- sqrt(diag(vc))
z  <- qnorm(0.975)
#Build dataframe with coefficients
est <- data.frame(
  term = names(co),
  beta = co,
  se   = se,
  OR   = exp(co),
  LCL  = exp(co - z*se),
  UCL  = exp(co + z*se),
  p    = 2*pnorm(-abs(co/se))
)
#Drop the intercept row when reporting
subset(est, term != "(Intercept)")
#Do design-adjusted wald test for interaction (p-value <.05 means the relationship between cannabis use and suicidal ideation significantly differs by the interaction term and coefficient for the interaction term is not equal to 0)
#regTermTest(fit_int, ~ NEWRACE2_4:IRMJFY2)
```

```{r plot residuals vs fitted values for adjusted PML model}
res_dev <- residuals(fit_int, type = "deviance")
plot(fitted(fit_int), res_dev, xlab="Fitted (p-hat)", ylab="Deviance residuals",
     main="Residuals vs Fitted (Deviance)", pch=19, col="steelblue")
abline(h=0, lty=2, col="red")
```
